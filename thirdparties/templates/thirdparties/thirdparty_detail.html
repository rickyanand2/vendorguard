{# Path: templates/thirdparties/thirdparty_detail.html #}
{% extends 'common/base.html' %}
{% load static %}

{% block content %}
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="fw-bold mb-0">{{ third_party.name }}</h2>
        <div class="text-muted">
          {{ third_party.website|default:'' }}
          {% if third_party.website %} · {% endif %}
          {{ third_party.get_lifecycle_status_display }}
          · {{ third_party.get_criticality_display }}
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'thirdparties:thirdparty_update' third_party.pk %}" class="btn btn-outline-primary"><i class="bi bi-pencil"></i> Edit</a>
        <form method="post" action="{% url 'thirdparties:thirdparty_archive' third_party.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Archive {{ third_party.name }}?');"><i class="bi bi-archive"></i> Archive</button>
        </form>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <p class="mb-3">
              <strong>Description</strong><br />{{ third_party.description|default:'—' }}
            </p>

            <div class="row g-3">
              <div class="col-md-3">
                <div class="small text-muted">Tier</div>
                <div class="fw-semibold">{{ third_party.get_tier_display }}</div>
              </div>
              <div class="col-md-3">
                <div class="small text-muted">Risk (0–100)</div>
                {% with val=third_party.risk_snapshot|default:0 %}
                  {% if val < 34 %}
                    <span class="badge bg-success">{{ val }}</span>
                  {% elif val < 67 %}
                    <span class="badge bg-warning text-dark">{{ val }}</span>
                  {% else %}
                    <span class="badge bg-danger">{{ val }}</span>
                  {% endif %}
                {% endwith %}
              </div>
              <div class="col-md-3">
                <div class="small text-muted">Trust (0–1000)</div>
                {% with trust=third_party.trust_profile %}
                  {% if trust and trust.trust_score is not None %}
                    {% if trust.trust_score < 334 %}
                      <span class="badge bg-success">{{ trust.trust_score }}</span>
                    {% elif trust.trust_score < 667 %}
                      <span class="badge bg-warning text-dark">{{ trust.trust_score }}</span>
                    {% else %}
                      <span class="badge bg-danger">{{ trust.trust_score }}</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary">–</span>
                  {% endif %}
                {% endwith %}
              </div>
              <div class="col-md-3">
                <div class="small text-muted">Data Types</div>
                {% if third_party.processes_pii %}
                  <span class="badge bg-info text-dark me-1">PII</span>
                {% endif %}
                {% if third_party.processes_pci %}
                  <span class="badge bg-warning text-dark me-1">PCI</span>
                {% endif %}
                {% if third_party.processes_phi %}
                  <span class="badge bg-danger me-1">PHI</span>
                {% endif %}
                {% if not third_party.processes_pii and not third_party.processes_pci and not third_party.processes_phi %}
                  <span class="text-muted">None</span>
                {% endif %}
              </div>
            </div>

            <div class="row g-3 mt-0">
              <div class="col-md-4">
                <div class="small text-muted">Last Assessed</div>
                <div class="fw-semibold">{{ third_party.last_assessed|date:'M d, Y'|default:'—' }}</div>
              </div>
              <div class="col-md-4">
                <div class="small text-muted">Next Review</div>
                <div class="fw-semibold">{{ third_party.next_review_due|date:'M d, Y'|default:'—' }}</div>
              </div>
              <div class="col-md-4">
                <div class="small text-muted">DPIA Required</div>
                <div class="fw-semibold">
                  {% if third_party.dpia_required %}
                    <span class="text-danger">Yes</span>
                  {% else %}
                    <span class="text-muted">No</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
          <h3 class="h5 mb-0">Services</h3>
          <a href="{% url 'thirdparties:service_create' third_party.pk %}" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle me-1"></i> Add Service</a>
        </div>

        <div class="card shadow-sm">
          <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Data Sensitivity</th>
                  <th>Data Types</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for svc in services %}
                  <tr>
                    <td>
                      <a class="text-decoration-none" href="{% url 'thirdparties:service_detail' svc.pk %}">{{ svc.name }}</a>
                    </td>
                    <td>{{ svc.get_service_type_display }}</td>
                    <td>{{ svc.get_data_sensitivity_display }}</td>
                    <td>
                      {% if svc.processes_pii %}
                        <span class="badge bg-info text-dark me-1">PII</span>
                      {% endif %}
                      {% if svc.processes_pci %}
                        <span class="badge bg-warning text-dark me-1">PCI</span>
                      {% endif %}
                      {% if svc.processes_phi %}
                        <span class="badge bg-danger me-1">PHI</span>
                      {% endif %}
                      {% if not svc.processes_pii and not svc.processes_pci and not svc.processes_phi %}
                        <span class="text-muted">None</span>
                      {% endif %}
                    </td>
                    <td class="text-end text-nowrap">
                      <a href="{% url 'thirdparties:service_update' svc.pk %}" class="btn btn-outline-primary btn-sm me-1"><i class="bi bi-pencil"></i> Edit</a>
                      <form method="post" action="{% url 'thirdparties:service_archive' svc.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Archive {{ svc.name }}?');"><i class="bi bi-archive"></i> Archive</button>
                      </form>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="text-center py-4 text-muted">No services yet.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header bg-light fw-semibold">Security Contacts</div>
          <div class="card-body">
            <div class="mb-2">
              <span class="text-muted">Support Email:</span> {{ third_party.support_email|default:'—' }}
            </div>
            <div class="mb-2">
              <span class="text-muted">Security Email:</span> {{ third_party.security_contact_email|default:'—' }}
            </div>
            <div>
              <span class="text-muted">Security Portal:</span> {{ third_party.security_portal_url|default:'—' }}
            </div>
          </div>
        </div>
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-light fw-semibold">Workflow</div>
          <div class="card-body">
            <div class="mb-2">
              <span class="text-muted">State:</span> {{ third_party.wf_state }}
            </div>
            <div>
              <span class="text-muted">Archived:</span> {% if third_party.archived %}
                Yes
              {% else %}
                No
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
